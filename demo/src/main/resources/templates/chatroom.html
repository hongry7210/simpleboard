<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title th:text="'채팅방 - ' + ${friend}">채팅방</title>
    <style>
        /* 채팅 UI 스타일 (생략) */
    </style>
</head>
<body>
<div class="chatroom-container">
    <div>
        <h2 th:text="'채팅방: ' + ${friend}"></h2>
        <div id="chat-window">
            <ul id="message-list">
                <li th:each="msg : ${chatHistory}"
                    th:classappend="${msg.sender == me} ? 'message-me' : 'message-friend'">
                    <span class="bubble" th:text="${msg.content}"></span>
                </li>
            </ul>

        </div>
        <form id="chat-form" autocomplete="off">
            <input type="text" id="chat-input" placeholder="메시지 입력" />
            <button type="button" id="send-btn">전송</button>
        </form>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.1.1/bundles/stomp.umd.min.js"></script>
<script th:inline="javascript">
    // 1. 전역 변수 선언
   let stompClient = null;

   // Thymeleaf에서 값 바인딩 (서버에서 제공), 없으면 기본값
   const username = /*[[${me}]]*/ 'me';
   const friend = /*[[${friend}]]*/ '상대';
   console.log(username, friend);

   function connect() {
       // SockJS로 소켓 연결
       const socket = new SockJS('/ws/chat');
        // StompJs 7.x는 StompJs.Stomp 사용
        stompClient = StompJs.Stomp.over(socket);

       stompClient.connect({}, function (frame) {
           console.log(username);
           stompClient.subscribe('/user/queue/messages', function (messageOutput) {
               console.log('addMessage');
               const msg = JSON.parse(messageOutput.body);
               addMessage(msg);
           });
       });
   }

   function sendMessage() {
       const content = document.getElementById('chat-input').value.trim();
       if(content && stompClient) {
        const msgObj = {
            sender: username,
            receiver: friend,
            content: content,
            time: new Date().toISOString()
        };
        stompClient.send("/app/chat.send", {}, JSON.stringify(msgObj));
        document.getElementById('chat-input').value = '';
        }
   }

   function addMessage(msg) {
       const list = document.getElementById('message-list');
       const li = document.createElement('li');
       li.className = (msg.sender === username) ? 'message-me' : 'message-friend';
       const span = document.createElement('span');
       span.className = 'bubble';
       span.textContent = msg.content;
       li.appendChild(span);
       list.appendChild(li);
       list.scrollTop = list.scrollHeight;
   }

   // 폼 이벤트 가로채기
   document.getElementById('chat-form').addEventListener('submit', function(e) {
       e.preventDefault();
       sendMessage();
   });
   document.getElementById('send-btn').onclick = sendMessage;

   connect();
</script>
</body>
</html>
